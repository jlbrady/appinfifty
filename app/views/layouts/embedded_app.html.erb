<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Test Layout</title>
        <style type="text/css">
            body, html
            {
                margin: 0; padding: 0; height: 100%; overflow: hidden;
            }

            #content
            {
                position:absolute; left: 0; right: 0; bottom: 0; top: 0px;
            }
        </style>
    </head>

  <body>
    <%= render 'layouts/flash_messages' %>

    <script src="https://cdn.shopify.com/s/assets/external/app.js?<%= Time.now.strftime('%Y%m%d%H') %>"></script>

    <script type="text/javascript">
      ShopifyApp.init({
        apiKey: "<%= ShopifyApp.configuration.api_key %>",
        shopOrigin: "<%= "https://#{ @shop_session.url }" if @shop_session %>",
        debug: true,
        forceRedirect: true
      });
    </script>
    <script type="text/javascript">
        ShopifyApp.ready(function(){
            ShopifyApp.Bar.initialize({});
        });
        console.log("Session URL: <%= "#{ @shop_session.url }" if @shop_session %>");
        console.log("Shop Name: <%= ShopifyAPI::Shop.current.name %>");
        console.log("Shop Access Token: <%= ShopifyAPI::Shop.headers['X-Shopify-Access-Token'] %>");
    </script>
    <script type="text/javascript">
      console.log("beforee findFrame");
      // can try to use the window.postmessage() function here? -- make sure its secure first
      // null value with .window and without -- cross origin issue here too how to postmessage?
          // cant use html_safe here need to sanitize inputs first
          var shopObj = <%= ShopifyAPI::Shop.current.to_json.to_s.html_safe %>;
          //var iframe = document.getElementById("pontiacFrame").window; this will never work with multiple origins
          console.log("begin findFrame");
          // never finds signUpUnderline
          //iframe.getElementById("signUpUnderline").onClick = function() {
          window.addEventListener("message", receiveMessage, false);
          function receiveMessage(event) {
              if (event.origin !== "https://26c05261.ngrok.io") {
                  console.log("Single origin policy protection");
              } else {
                  // this is not a window like it needs to be event origin is just a url
                  // this is where the issue lies
                  //event.origin.postMessage(shopObj, "https://26c05261.ngrok.io");
                  console.log("event.origin: " + event.origin);
              }
          }
          console.log("end findFrame");
    </script>
      <iframe id="pontiacFrame" width="100%" height="100%" frameborder="0" src="https://26c05261.ngrok.io/#/"/>

    <% if content_for?(:javascript) %>
      <div id="ContentForJavascript" data-turbolinks-temporary>
        <%= yield :javascript %>
      </div>
    <% end %>
  </body>
</html>
